apiVersion: security.kubearmor.com/v1
kind: KubeArmorPolicy
metadata:
  name: ksp-doki-malware
  namespace: default
spec:
  tags: ["DOKI","MALWARE"]
  message: "Alert! Doki malware execution stopped"
  selector:
    matchLabels:
      container: ubuntu-1
  process:
    severity: 3
    matchPaths:
    - path: /bin/sh
    action: Audit
  file:
    severity: 3
    matchPaths:
    - path: /tmp/update.sh
    matchPatterns:
    - pattern: /**/update.sh
    # Patterns are created from YARA rules
    - pattern: /curl --retry 3 -m 60 -o \/tmp\w{6}\/tmp\/tmp.{37}.*\\{3}\"http:\/{2}.*\.ngrok\.io[\s\S]*\\{3}\";/
    - pattern: /rm -rf \/tmp\w{6}\/etc\/crontab;/
    - pattern: /echo \\{3}\"(\*\s){4}\* root sh \/tmp\/tmp.*\\{3}\" \\{2}u003e\/tmp\w{6}\/etc\/cron.d\/1m;/
    - pattern: /echo \\{3}\"(\*\s){4}\* root sh \/tmp\/tmp\w*\\{3}\" \\{2}u003e\/tmp\w{6}\/etc\/crontab;/
    - pattern: /chroot \/tmp\w{6} sh -c \\{3}\"cron \|\| crond/
    action: Block
